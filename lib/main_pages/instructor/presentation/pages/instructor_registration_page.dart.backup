// lib/main_pages/instructor/presentation/instructor_registration_page.dart

import 'package:courses_app/bloc/user_role_bloc.dart';
import 'package:courses_app/core/utils/theme_manager.dart';
import 'package:courses_app/services/instructor_service.dart';
import 'package:courses_app/theme_cubit/theme_cubit.dart';
import 'package:courses_app/theme_cubit/theme_state.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:file_picker/file_picker.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';
import 'dart:io';

class InstructorRegistrationPage extends StatefulWidget {
  const InstructorRegistrationPage({super.key});

  @override
  State<InstructorRegistrationPage> createState() =>
      _InstructorRegistrationPageState();
}

class _InstructorRegistrationPageState extends State<InstructorRegistrationPage>
    with SingleTickerProviderStateMixin {
  final _formKey = GlobalKey<FormState>();
  final InstructorService _instructorService = InstructorService();
  late AnimationController _animationController;
  late Animation<double> _fadeAnimation;

  // Form Controllers
  final _experienceController = TextEditingController();
  final _linkedinController = TextEditingController();
  final _portfolioController = TextEditingController();

  // Form Variables
  String? _selectedEducationLevel;
  String? _selectedDepartment;
  double _yearsOfExperience = 0;
  List<PlatformFile> _uploadedCertificates = [];
  bool _agreedToTerms = false;
  bool _isSubmitting = false;

  // Education Levels
  final List<String> _educationLevels = [
    'طالب/طالبة في المدرسة',
    'طالب/طالبة جامعي (بكالوريوس)',
    'طالب/طالبة دراسات عليا (ماجستير)',
    'طالب/طالبة دراسات عليا (دكتوراه)',
    'خريج/خريجة',
    'موظف/موظفة',
    'غير ذلك / فئة أخرى',
  ];

  // Departments with subcategories
  final Map<String, List<String>> _departmentsMap = {
    'التكنولوجيا والبرمجة': [
      'تطوير الويب - Front-end',
      'تطوير الويب - Back-end',
      'تطوير الويب - Full-Stack',
      'تطوير تطبيقات iOS',
      'تطوير تطبيقات Android',
      'تطوير تطبيقات Flutter',
      'React Native',
      'الذكاء الاصطناعي',
      'تعلم الآلة',
      'علم البيانات',
      'الأمن السيبراني',
      'قواعد البيانات',
      'الشبكات',
      'برمجة الألعاب',
      'أنظمة التشغيل',
    ],
    'الأعمال والإدارة': [
      'ريادة الأعمال',
      'إدارة الأعمال',
      'التسويق الرقمي',
      'تحسين محركات البحث SEO',
      'التسويق بالمحتوى',
      'إعلانات وسائل التواصل',
      'المبيعات',
      'المالية والمحاسبة',
      'إدارة المشاريع',
      'الموارد البشرية',
    ],
    'الإبداع والتصميم': [
      'التصميم الجرافيكي',
      'UI/UX Design',
      'تصميم الويب',
      'التصوير الفوتوغرافي',
      'مونتاج الفيديو',
      'الرسوم المتحركة',
      'التصميم ثلاثي الأبعاد',
      'الموسيقى والصوت',
    ],
    'التنمية الشخصية والمهارات العامة': [
      'اللغات',
      'القيادة والإدارة',
      'التواصل والعرض',
      'الإنتاجية وتطوير الذات',
      'الذكاء العاطفي',
    ],
    'الفنون والعلوم الإنسانية': [
      'الكتابة الإبداعية',
      'التاريخ والفلسفة',
      'الأدب',
      'الموسيقى',
      'علم النفس',
    ],
    'الصحة واللياقة البدنية': [
      'اللياقة البدنية',
      'التغذية',
      'الصحة النفسية',
      'الطب البديل',
    ],
    'المجالات الأكاديمية والتخصصية': [
      'العلوم',
      'الهندسة',
      'الطب والصحة',
      'القانون',
      'التعليم',
    ],
    'المهارات الحياتية والأعمال اليدوية': [
      'الطهي',
      'الأعمال اليدوية',
      'الإدارة المالية الشخصية',
      'الرعاية الشخصية',
    ],
  };

  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 600),
      vsync: this,
    );
    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeIn),
    );
    _animationController.forward();
    _loadSavedData();
  }

  @override
  void dispose() {
    _animationController.dispose();
    _experienceController.dispose();
    _linkedinController.dispose();
    _portfolioController.dispose();
    super.dispose();
  }

  // Load saved form data
  Future<void> _loadSavedData() async {
    final prefs = await SharedPreferences.getInstance();
    final savedData = prefs.getString('instructor_form_data');
    if (savedData != null) {
      final data = json.decode(savedData);
      setState(() {
        _experienceController.text = data['experience'] ?? '';
        _linkedinController.text = data['linkedin'] ?? '';
        _portfolioController.text = data['portfolio'] ?? '';
        _selectedEducationLevel = data['educationLevel'];
        _selectedDepartment = data['department'];
        _yearsOfExperience = data['yearsOfExperience'] ?? 0;
      });
    }
  }

  // Save form data
  Future<void> _saveFormData() async {
    final prefs = await SharedPreferences.getInstance();
    final data = {
      'experience': _experienceController.text,
      'linkedin': _linkedinController.text,
      'portfolio': _portfolioController.text,
      'educationLevel': _selectedEducationLevel,
      'department': _selectedDepartment,
      'yearsOfExperience': _yearsOfExperience,
    };
    await prefs.setString('instructor_form_data', json.encode(data));
  }

  // Calculate form completion percentage
  double _calculateProgress() {
    double progress = 0;
    double stepValue = 1 / 5; // 5 حقول إجبارية

    // 1. المستوى التعليمي
    if (_selectedEducationLevel != null) progress += stepValue;

    // 2. التخصص
    if (_selectedDepartment != null) progress += stepValue;

    // 3. الخبرة التدريسية (يجب أن تكون أكثر من 0)
    if (_yearsOfExperience > 0) progress += stepValue;

    // 4. وصف الخبرات (40 حرف على الأقل)
    if (_experienceController.text.length >= 40) progress += stepValue;

    // 5. الموافقة على الشروط
    if (_agreedToTerms) progress += stepValue;

    return progress.clamp(0.0, 1.0);
  }

  // Pick files for certificates
  Future<void> _pickFiles() async {
    try {
      FilePickerResult? result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['pdf', 'jpg', 'jpeg', 'png'],
        allowMultiple: true,
      );

      if (result != null) {
        for (var file in result.files) {
          if (file.size <= 15 * 1024 * 1024) {
            // 15MB limit
            setState(() {
              _uploadedCertificates.add(file);
            });
          } else {
            _showErrorSnackbar('حجم الملف ${file.name} أكبر من 15MB');
          }
        }
      }
    } catch (e) {
      _showErrorSnackbar('حدث خطأ في رفع الملفات');
    }
  }

  // Remove certificate
  void _removeCertificate(int index) {
    setState(() {
      _uploadedCertificates.removeAt(index);
    });
  }

  // Show error snackbar
  void _showErrorSnackbar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message, style: GoogleFonts.tajawal()),
  Future<void> _submitForm() async {
    if (!_formKey.currentState!.validate()) {
      _showErrorSnackbar('يرجى ملء جميع الحقول المطلوبة');
      return;
    }

    // التحقق من سنوات الخبرة
    if (_yearsOfExperience == 0) {
      _showErrorSnackbar('يجب تحديد سنوات الخبرة');
      return;
    }

    if (!_agreedToTerms) {
      _showErrorSnackbar('يجب الموافقة على الشروط والأحكام');
      return;
    }

    setState(() {
      _isSubmitting = true;
    });

    try {
      // Convert PlatformFile to File for upload
      List<File> certificateFiles = [];
      for (var platformFile in _uploadedCertificates) {
        if (platformFile.path != null) {
          certificateFiles.add(File(platformFile.path!));
        }
      }

      // Call real API
      final result = await _instructorService.applyToInstructor(
        educationLevel: _selectedEducationLevel!,
        department: _selectedDepartment!,
        yearsOfExperience: _yearsOfExperience,
        experienceDescription: _experienceController.text,
        linkedinUrl: _linkedinController.text.trim().isEmpty 
            ? null 
            : _linkedinController.text.trim(),
        portfolioUrl: _portfolioController.text.trim().isEmpty 
            ? null 
            : _portfolioController.text.trim(),
        certificates: certificateFiles.isNotEmpty ? certificateFiles : null,
      );

      if (!mounted) return;

      // Clear saved data
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove('instructor_form_data');

      setState(() {
        _isSubmitting = false;
      });

      if (result['success']) {
        // Show success dialog
        _showSuccessDialog();
      } else {
        _showErrorSnackbar(result['message'] ?? 'فشل إرسال الطلب');
      }
    } catch (e) {
      if (!mounted) return;
      
      setState(() {
        _isSubmitting = false;
      });
      
      _showErrorSnackbar('حدث خطأ: ${e.toString()}');
    }
  }

  // Show success dialog
  void _showSuccessDialog() {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        child: Container(
          padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.05),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Color(0xFF667EEA), Color(0xFF764BA2)],
                  ),
                  shape: BoxShape.circle,
                ),
                child: Icon(Icons.check, color: Colors.white, size: 40),
              ),
              const SizedBox(height: 24),
              Text(
                'تم إرسال طلبك بنجاح',
                style: GoogleFonts.tajawal(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 12),
              Text(
                'طلبك قيد المراجعة\nسيتم الرد خلال 2-3 أيام ',
                style: GoogleFonts.tajawal(fontSize: 14, color: Colors.grey[600]),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 20),
              SizedBox(
                width: double.infinity,
                child: TextButton(
                  onPressed: () {
                    Navigator.pop(context);
                    Navigator.pop(context);
                  },
                  style: TextButton.styleFrom(
                    backgroundColor: Color(0xFF667EEA),
                    padding: EdgeInsets.symmetric(vertical: 12),
                  ),
                  child: Text(
                    'حسناً',
                    style: GoogleFonts.tajawal(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // Show terms dialog
  void _showTermsDialog() {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        child: Container(
          padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.05),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'الشروط والأحكام',
                style: GoogleFonts.tajawal(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 16),
              Expanded(
                child: SingleChildScrollView(
                  child: Text(
                    '''شروط الانضمام كمدرس:

1. يجب أن يكون لديك خبرة في المجال الذي تريد التدريس فيه
2. الالتزام بجودة المحتوى المقدم
3. احترام حقوق الملكية الفكرية
4. الالتزام بسياسات المنصة
5. تقديم محتوى تعليمي قيّم ومفيد

بالموافقة على هذه الشروط، فإنك توافق على جميع سياسات المنصة.''',
                    style: GoogleFonts.tajawal(height: 1.5),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              SizedBox(
                width: double.infinity,
                child: TextButton(
                  onPressed: () => Navigator.pop(context),
                  style: TextButton.styleFrom(
                    backgroundColor: Color(0xFF667EEA),
                    padding: EdgeInsets.symmetric(vertical: 12),
                  ),
                  child: Text(
                    'إغلاق',
                    style: GoogleFonts.tajawal(color: Colors.white),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<ThemeCubit, ThemeState>(
      builder: (context, themeState) {
        final isDarkMode = themeState.isDarkMode;

        return Theme(
          data: isDarkMode ? ThemeManager.darkTheme : ThemeManager.lightTheme,
          child: Scaffold(
            backgroundColor: _getBackgroundColor(isDarkMode),
            appBar: _buildAppBar(isDarkMode),
            body: FadeTransition(
              opacity: _fadeAnimation,
              child: LayoutBuilder(
                builder: (context, constraints) {
                  final screenWidth = constraints.maxWidth;
                  final isTablet = screenWidth > 768;
                  final isLargeTablet = screenWidth > 1024;
                  
                  return SingleChildScrollView(
                    padding: EdgeInsets.symmetric(
                      horizontal: screenWidth * 0.04,
                      vertical: screenWidth * 0.03,
                    ).clamp(
                      EdgeInsets.zero,
                      EdgeInsets.all(32),
                    ),
                    child: ConstrainedBox(
                      constraints: BoxConstraints(
                        minHeight: constraints.maxHeight,
                      ),
                      child: Form(
                        key: _formKey,
                        onChanged: _saveFormData,
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            _buildHeader(isDarkMode),
                            const SizedBox(height: 24),
                            _buildProgressIndicator(isDarkMode),
                            const SizedBox(height: 32),
                            if (isLargeTablet)
                              _buildLargeTabletLayout(isDarkMode)
                            else if (isTablet)
                              _buildTabletLayout(isDarkMode)
                            else
                              _buildMobileLayout(isDarkMode),
                            const SizedBox(height: 32),
                            _buildSubmitButton(isDarkMode),
                            SizedBox(height: MediaQuery.of(context).padding.bottom),
                          ],
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
        );
      },
    );
  }

  // Build app bar
  PreferredSizeWidget _buildAppBar(bool isDarkMode) {
    return AppBar(
      backgroundColor: isDarkMode ? const Color(0xFF1E1E1E) : Colors.white,
      elevation: 0,
      leading: IconButton(
        icon: Icon(Icons.arrow_back_ios, color: _getTextColor(isDarkMode)),
        onPressed: () => Navigator.pop(context),
      ),
      title: Text(
        'التسجيل كمدرس',
        style: GoogleFonts.tajawal(
          color: _getTextColor(isDarkMode),
          fontWeight: FontWeight.bold,
        ),
      ),
      centerTitle: true,
    );
  }

  // Build header
  Widget _buildHeader(bool isDarkMode) {
    return Center(
      child: Column(
        children: [
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Color(0xFF667EEA), Color(0xFF764BA2)],
              ),
              shape: BoxShape.circle,
            ),
            child: Icon(Icons.school, color: Colors.white, size: 40),
          ),
          const SizedBox(height: 16),
          Text(
            'انضم كمدرس معتمد',
            style: GoogleFonts.tajawal(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: _getTextColor(isDarkMode),
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),
          Padding(
            padding: EdgeInsets.symmetric(horizontal: 20),
            child: Text(
              'املأ البيانات التالية لتصبح مدرساً في منصتنا',
              style: GoogleFonts.tajawal(
                fontSize: 14,
                color: _getSecondaryTextColor(isDarkMode),
              ),
              textAlign: TextAlign.center,
            ),
          ),
        ],
      ),
    );
  }

  // Build progress indicator
  Widget _buildProgressIndicator(bool isDarkMode) {
    final progress = _calculateProgress();
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'نسبة الإكمال',
                style: GoogleFonts.tajawal(
                  fontWeight: FontWeight.bold,
                  color: _getTextColor(isDarkMode),
                ),
              ),
              Text(
                '${(progress * 100).toInt()}%',
                style: GoogleFonts.tajawal(
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF667EEA),
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          LinearProgressIndicator(
            value: progress,
            minHeight: 8,
            backgroundColor: isDarkMode ? Colors.grey[700] : Colors.grey[200],
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF667EEA)),
          ),
        ],
      ),
    );
  }

  // Build large tablet layout (3 columns)
  Widget _buildLargeTabletLayout(bool isDarkMode) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          child: Column(
            children: [
              _buildEducationSection(isDarkMode),
              const SizedBox(height: 24),
              _buildExperienceSection(isDarkMode),
            ],
          ),
        ),
        const SizedBox(width: 20),
        Expanded(
          child: Column(
            children: [
              _buildDepartmentSection(isDarkMode),
              const SizedBox(height: 24),
              _buildCertificatesSection(isDarkMode),
            ],
          ),
        ),
        const SizedBox(width: 20),
        Expanded(
          child: Column(
            children: [
              _buildAdditionalInfoSection(isDarkMode),
              const SizedBox(height: 24),
              _buildTermsSection(isDarkMode),
            ],
          ),
        ),
      ],
    );
  }

  // Build tablet layout (2 columns)
  Widget _buildTabletLayout(bool isDarkMode) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          child: Column(
            children: [
              _buildEducationSection(isDarkMode),
              const SizedBox(height: 24),
              _buildDepartmentSection(isDarkMode),
              const SizedBox(height: 24),
              _buildTermsSection(isDarkMode),
            ],
          ),
        ),
        const SizedBox(width: 20),
        Expanded(
          child: Column(
            children: [
              _buildExperienceSection(isDarkMode),
              const SizedBox(height: 24),
              _buildCertificatesSection(isDarkMode),
              const SizedBox(height: 24),
              _buildAdditionalInfoSection(isDarkMode),
            ],
          ),
        ),
      ],
    );
  }

  // Build mobile layout
  Widget _buildMobileLayout(bool isDarkMode) {
    return Column(
      children: [
        _buildEducationSection(isDarkMode),
        const SizedBox(height: 20),
        _buildDepartmentSection(isDarkMode),
        const SizedBox(height: 20),
        _buildExperienceSection(isDarkMode),
        const SizedBox(height: 20),
        _buildCertificatesSection(isDarkMode),
        const SizedBox(height: 20),
        _buildAdditionalInfoSection(isDarkMode),
        const SizedBox(height: 20),
        _buildTermsSection(isDarkMode),
      ],
    );
  }

  // Build education section
  Widget _buildEducationSection(bool isDarkMode) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildSectionTitle('المستوى التعليمي', Icons.school, isDarkMode),
          const SizedBox(height: 20),
          DropdownButtonFormField<String>(
            value: _selectedEducationLevel,
            isExpanded: true,
            decoration: InputDecoration(
              labelText: 'المستوى التعليمي الحالي *',
              prefixIcon: Icon(Icons.school_outlined),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
              ),
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 16),
            ),
            items: _educationLevels.map((level) {
              return DropdownMenuItem(
                value: level,
                child: Text(
                  level,
                  style: GoogleFonts.tajawal(),
                  overflow: TextOverflow.ellipsis,
                ),
              );
            }).toList(),
            onChanged: (value) {
              setState(() {
                _selectedEducationLevel = value;
              });
            },
            validator: (value) {
              if (value == null) {
                return 'هذا الحقل مطلوب';
              }
              return null;
            },
          ),
        ],
      ),
    );
  }

  // Build department section
  Widget _buildDepartmentSection(bool isDarkMode) {
    List<String> allDepartments = [];
    _departmentsMap.forEach((key, values) {
      allDepartments.addAll(values.map((v) => '$key - $v'));
    });

    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildSectionTitle('التخصص', Icons.category, isDarkMode),
          const SizedBox(height: 20),
          Autocomplete<String>(
            optionsBuilder: (TextEditingValue textEditingValue) {
              if (textEditingValue.text == '') {
                return allDepartments;
              }
              return allDepartments.where((String option) {
                return option.toLowerCase().contains(
                  textEditingValue.text.toLowerCase(),
                );
              });
            },
            onSelected: (String selection) {
              setState(() {
                _selectedDepartment = selection;
              });
            },
            fieldViewBuilder:
                (
                  BuildContext context,
                  TextEditingController textEditingController,
                  FocusNode focusNode,
                  VoidCallback onFieldSubmitted,
                ) {
                  textEditingController.text = _selectedDepartment ?? '';
                  return TextFormField(
                    controller: textEditingController,
                    focusNode: focusNode,
                    decoration: InputDecoration(
                      labelText: 'تحديد نوع القسم *',
                      prefixIcon: Icon(Icons.category_outlined),
                      suffixIcon: Icon(Icons.search),
                      hintText: 'اختر القسم المناسب لخبرتك',
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                      contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 16),
                    ),
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'هذا الحقل مطلوب';
                      }
                      return null;
                    },
                  );
                },
            optionsViewBuilder:
                (
                  BuildContext context,
                  AutocompleteOnSelected<String> onSelected,
                  Iterable<String> options,
                ) {
                  return Align(
                    alignment: Alignment.topLeft,
                    child: Material(
                      elevation: 4.0,
                      borderRadius: BorderRadius.circular(8),
                      child: Container(
                        constraints: BoxConstraints(maxHeight: 200),
                        width: MediaQuery.of(context).size.width * 0.8,
                        decoration: BoxDecoration(
                          color: _getCardColor(isDarkMode),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: ListView.builder(
                          padding: EdgeInsets.zero,
                          shrinkWrap: true,
                          itemCount: options.length,
                          itemBuilder: (BuildContext context, int index) {
                            final String option = options.elementAt(index);
                            return ListTile(
                              title: Text(
                                option,
                                style: GoogleFonts.tajawal(
                                  fontSize: 14,
                                  color: _getTextColor(isDarkMode),
                                ),
                                overflow: TextOverflow.ellipsis,
                              ),
                              onTap: () {
                                onSelected(option);
                              },
                            );
                          },
                        ),
                      ),
                    ),
                  );
                },
          ),
        ],
      ),
    );
  }

  // Build experience section
  Widget _buildExperienceSection(bool isDarkMode) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildSectionTitle('الخبرة التدريسية', Icons.work, isDarkMode),
          const SizedBox(height: 20),
          Text(
            'سنوات الخبرة: ${_yearsOfExperience.toInt()} سنة',
            style: GoogleFonts.tajawal(
              fontWeight: FontWeight.bold,
              color: _getTextColor(isDarkMode),
            ),
          ),
          const SizedBox(height: 12),
          Slider(
            value: _yearsOfExperience,
            min: 0,
            max: 30,
            divisions: 30,
            activeColor: Color(0xFF667EEA),
            label: '${_yearsOfExperience.toInt()} سنة',
            onChanged: (value) {
              setState(() {
                _yearsOfExperience = value;
              });
            },
          ),
          const SizedBox(height: 20),
          TextFormField(
            controller: _experienceController,
            maxLines: 5,
            decoration: InputDecoration(
              labelText: 'وصف الخبرات الشخصية *',
              hintText: 'اكتب نبذة عن خبراتك في مجال التدريس والتخصص...',
              alignLabelWithHint: true,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
              ),
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 16),
            ),
            validator: (value) {
              if (value == null || value.isEmpty) {
                return 'هذا الحقل مطلوب';
              }
              if (value.length < 40) {
                return 'يجب أن يحتوي الوصف على 40 حرف على الأقل';
              }
              return null;
            },
          ),
        ],
      ),
    );
  }

  // Build certificates section
  Widget _buildCertificatesSection(bool isDarkMode) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildSectionTitle(
            'الشهادات (اختياري)',
            Icons.workspace_premium,
            isDarkMode,
          ),
          const SizedBox(height: 20),
          InkWell(
            onTap: _pickFiles,
            borderRadius: BorderRadius.circular(8),
            child: Container(
              width: double.infinity,
              padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
              decoration: BoxDecoration(
                border: Border.all(
                  color: isDarkMode ? Colors.grey[700]! : Colors.grey[300]!,
                  style: BorderStyle.solid,
                  width: 2,
                ),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(Icons.upload_file, color: Color(0xFF667EEA)),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'إضافة الشهادات المكتسبة',
                          style: GoogleFonts.tajawal(
                            fontWeight: FontWeight.bold,
                            color: _getTextColor(isDarkMode),
                          ),
                        ),
                        Text(
                          'اختياري - PDF, JPG, PNG (حد أقصى 15MB)',
                          style: GoogleFonts.tajawal(
                            fontSize: 12,
                            color: _getSecondaryTextColor(isDarkMode),
                          ),
                        ),
                      ],
                    ),
                  ),
                  Icon(Icons.add_circle, color: Color(0xFF667EEA)),
                ],
              ),
            ),
          ),
          if (_uploadedCertificates.isNotEmpty) ...[
            const SizedBox(height: 16),
            ListView.builder(
              shrinkWrap: true,
              physics: NeverScrollableScrollPhysics(),
              itemCount: _uploadedCertificates.length,
              itemBuilder: (context, index) {
                final file = _uploadedCertificates[index];
                return Card(
                  margin: const EdgeInsets.only(bottom: 8),
                  child: ListTile(
                    leading: Icon(
                      Icons.insert_drive_file,
                      color: Color(0xFF667EEA),
                    ),
                    title: Text(
                      file.name,
                      style: GoogleFonts.tajawal(
                        fontSize: 14,
                        color: _getTextColor(isDarkMode),
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                    subtitle: Text(
                      '${(file.size / 1024 / 1024).toStringAsFixed(2)} MB',
                      style: GoogleFonts.tajawal(
                        fontSize: 12,
                        color: _getSecondaryTextColor(isDarkMode),
                      ),
                    ),
                    trailing: IconButton(
                      icon: Icon(Icons.delete, color: Colors.red),
                      onPressed: () => _removeCertificate(index),
                    ),
                  ),
                );
              },
            ),
          ],
        ],
      ),
    );
  }

  // Build additional info section
  Widget _buildAdditionalInfoSection(bool isDarkMode) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildSectionTitle('معلومات إضافية', Icons.info, isDarkMode),
          const SizedBox(height: 20),
          TextFormField(
            controller: _linkedinController,
            decoration: InputDecoration(
              labelText: 'رابط LinkedIn (اختياري)',
              prefixIcon: Icon(Icons.link),
              hintText: 'https://linkedin.com/in/username',
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
              ),
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 16),
            ),
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _portfolioController,
            decoration: InputDecoration(
              labelText: 'الموقع الشخصي/Portfolio (اختياري)',
              prefixIcon: Icon(Icons.language),
              hintText: 'https://example.com',
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
              ),
              contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 16),
            ),
          ),
        ],
      ),
    );
  }

  // Build terms section
  Widget _buildTermsSection(bool isDarkMode) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(MediaQuery.of(context).size.width * 0.04),
      decoration: BoxDecoration(
        color: _getCardColor(isDarkMode),
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          CheckboxListTile(
            value: _agreedToTerms,
            onChanged: (value) {
              setState(() {
                _agreedToTerms = value ?? false;
              });
            },
            title: Text(
              'أوافق على الشروط والأحكام',
              style: GoogleFonts.tajawal(
                fontWeight: FontWeight.bold,
                color: _getTextColor(isDarkMode),
              ),
            ),
            subtitle: GestureDetector(
              onTap: _showTermsDialog,
              child: Text(
                'اضغط لقراءة الشروط والأحكام',
                style: GoogleFonts.tajawal(
                  fontSize: 12,
                  color: Color(0xFF667EEA),
                  decoration: TextDecoration.underline,
                ),
              ),
            ),
            controlAffinity: ListTileControlAffinity.leading,
            contentPadding: EdgeInsets.zero,
          ),
        ],
      ),
    );
  }

  // Build submit button
  Widget _buildSubmitButton(bool isDarkMode) {
    // التحقق من اكتمال جميع الحقول الإجبارية (100%)
    final isFormValid = _calculateProgress() == 1.0;

    return Container(
      width: double.infinity,
      height: 56,
      decoration: BoxDecoration(
        gradient: isFormValid
            ? LinearGradient(
                colors: [Color(0xFF667EEA), Color(0xFF764BA2)],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              )
            : null,
        color: isFormValid ? null : Colors.grey,
        borderRadius: BorderRadius.circular(12),
        boxShadow: isFormValid
            ? [
                BoxShadow(
                  color: Color(0xFF667EEA).withOpacity(0.3),
                  blurRadius: 8,
                  offset: const Offset(0, 4),
                ),
              ]
            : null,
      ),
      child: InkWell(
        borderRadius: BorderRadius.circular(12),
        onTap: isFormValid && !_isSubmitting ? _submitForm : null,
        child: Center(
          child: _isSubmitting
              ? CircularProgressIndicator(color: Colors.white)
              : Text(
                  'إرسال طلب الانضمام',
                  style: GoogleFonts.tajawal(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
        ),
      ),
    );
  }

  // Build section title
  Widget _buildSectionTitle(String title, IconData icon, bool isDarkMode) {
    return Row(
      children: [
        Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                Color(0xFF667EEA).withOpacity(0.2),
                Color(0xFF764BA2).withOpacity(0.2),
              ],
            ),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: Color(0xFF667EEA), size: 20),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Text(
            title,
            style: GoogleFonts.tajawal(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: _getTextColor(isDarkMode),
            ),
          ),
        ),
      ],
    );
  }

  // Helper methods for colors
  Color _getTextColor(bool isDarkMode) {
    return isDarkMode ? Colors.white : const Color(0xFF1E293B);
  }

  Color _getCardColor(bool isDarkMode) {
    return isDarkMode ? const Color(0xFF1E1E1E) : Colors.white;
  }

  Color _getBackgroundColor(bool isDarkMode) {
    return isDarkMode ? const Color(0xFF121212) : const Color(0xFFF8FAFC);
  }

  Color _getSecondaryTextColor(bool isDarkMode) {
    return isDarkMode ? Colors.grey[400]! : Colors.grey[600]!;
  }
}